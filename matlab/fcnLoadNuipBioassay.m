function TB2 = fcnLoadNuipBioassay(ScObj,bioassayId)

% TB = readcell('master_mix.log',...
%      'FileType','text');

clc
% TB = readtable('master_mix.log',...
%     'FileType','text',...
%     'ReadVariableNames',false,...
%     'Delimiter',{',',' '});
% head(TB)
if (bioassayId==1)
    TB = {...
      {'n00'}, {'Dis'}, {}, {}, {[15.5, 2.5]}, {};...
      {'n01'}, {'Dis'}, {}, {}, {[45.5, 2.5]}, {};...
      {'n02'}, {'Dis'}, {}, {}, {[45.5, 27.5]}, {};...
      {'n03'}, {'Dis'}, {}, {}, {[15.5, 27.5]}, {};...
      {'n04'}, {'Dis'}, {}, {'n06'}, {[45.5, 27.5]}, {};...
      {'n05'}, {'Mix'}, {'n00', 'n01'}, {}, {[15.5, 20.5]}, {};...
      {'n06'}, {'Mix'}, {'n11', 'n02'}, {}, {[45.5, 10.5]}, {2};...
      {'n07'}, {'Mix'}, {'n06', 'n03'}, {}, {[45.5, 20.5]}, {};...
      {'n08'}, {'Mix'}, {'n07', 'n04'}, {'n09'}, {[15.5, 20.5]}, {};...
      {'n09'}, {'Mag'}, {'n05'}, {}, {[15.5, 10.5]}, {};...
      {'n10'}, {'Mag'}, {'n08'}, {'n11'}, {[15.5, 10.5]}, {};...
      {'n11'}, {'Spt'}, {'n09'}, {}, {[25.5, 10.5]}, {};...
      {'n12'}, {'Spt'}, {'n10'}, {'n06', 'n13'}, {[25.5, 10.5]}, {};...
      {'n13'}, {'Out'}, {'n11'}, {}, {[2.5, 15.5]}, {1};...
      {'n14'}, {'Out'}, {'n12'}, {}, {[2.5, 15.5]}, {1};...
      {'n15'}, {'Out'}, {'n12'}, {}, {[57.5, 15.5]}, {2};...
    };
elseif (bioassayId==2)
    % NuIP With 2 RepEtiTions
    TB = {...
    {'n00'}, {'Dis'}, {}, {}, {[15.5, 2.5]}, {};...
    {'n01'}, {'Dis'}, {}, {}, {[45.5, 2.5]}, {1,1};...
    {'n02'}, {'Dis'}, {}, {}, {[45.5, 27.5]}, {1,1};...
    {'n03'}, {'Dis'}, {}, {'n07'}, {[45.5, 27.5]}, {1,1};...
    {'n04'}, {'Dis'}, {}, {}, {[15.5, 27.5]}, {1,1};...
    {'n05'}, {'Dis'}, {}, {'n08'}, {[45.5, 27.5]}, {1,1};...
    {'n06'}, {'Mix'}, {'n00', 'n01'}, {}, {[15.5, 20.5]}, {1,1};...
    {'n07'}, {'Mix'}, {'n14', 'n02'}, {}, {[45.5, 10.5]}, {2,1};...
    {'n08'}, {'Mix'}, {'n15', 'n03'}, {}, {[45.5, 20.5]}, {2,1};...
    {'n09'}, {'Mix'}, {'n08', 'n04'}, {'n11'}, {[15.5, 20.5]}, {1,1};...
    {'n10'}, {'Mix'}, {'n09', 'n05'}, {'n12'}, {[45.5, 10.5]}, {1,1};...
    {'n11'}, {'Mag'}, {'n06'}, {}, {[15.5, 10.5]}, {1,1};...
    {'n12'}, {'Mag'}, {'n07'}, {'n14'}, {[15.5, 10.5]}, {1,1};...
    {'n13'}, {'Mag'}, {'n10'}, {'n15'}, {[15.5, 10.5]}, {1,1};...
    {'n14'}, {'Spt'}, {'n11'}, {}, {[25.5, 10.5]}, {1,1};...
    {'n15'}, {'Spt'}, {'n12'}, {'n07', 'n17'}, {[25.5, 10.5]}, {1,1};...
    {'n16'}, {'Spt'}, {'n13'}, {'n08', 'n18'}, {[25.5, 10.5]}, {1,1};...
    {'n17'}, {'Dsc'}, {'n14'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n18'}, {'Dsc'}, {'n15'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n19'}, {'Out'}, {'n16'}, {}, {[57.5, 15.5]}, {2,1};...
    {'n20'}, {'Dsc'}, {'n16'}, {}, {[2.5, 15.5]}, {1,1};...
    };
elseif (bioassayId==4)
    % NuIP With 4 RepEtiTions
    TB = {...
    {'n00'}, {'Dis'}, {}, {}, {[15.5, 2.5]}, {};...
    {'n01'}, {'Dis'}, {}, {}, {[45.5, 2.5]}, {1,1};...
    {'n02'}, {'Dis'}, {}, {}, {[45.5, 27.5]}, {1,1};...
    {'n03'}, {'Dis'}, {}, {'n09'}, {[45.5, 27.5]}, {1,1};...
    {'n04'}, {'Dis'}, {}, {'n10'}, {[45.5, 27.5]}, {1,1};...
    {'n05'}, {'Dis'}, {}, {'n11'}, {[45.5, 27.5]}, {1,1};...
    {'n06'}, {'Dis'}, {}, {}, {[15.5, 27.5]}, {1,1};...
    {'n07'}, {'Dis'}, {}, {'n12'}, {[45.5, 27.5]}, {1,1};...
    {'n08'}, {'Mix'}, {'n00', 'n01'}, {}, {[15.5, 20.5]}, {1,1};...
    {'n09'}, {'Mix'}, {'n20', 'n02'}, {}, {[45.5, 10.5]}, {2,1};...
    {'n10'}, {'Mix'}, {'n21', 'n03'}, {}, {[45.5, 20.5]}, {2,1};...
    {'n11'}, {'Mix'}, {'n22', 'n04'}, {'n15'}, {[15.5, 20.5]}, {2,1};...
    {'n12'}, {'Mix'}, {'n23', 'n05'}, {'n16'}, {[45.5, 10.5]}, {2,1};...
    {'n13'}, {'Mix'}, {'n12', 'n06'}, {'n17'}, {[45.5, 20.5]}, {1,1};...
    {'n14'}, {'Mix'}, {'n13', 'n07'}, {'n18'}, {[15.5, 20.5]}, {1,1};...
    {'n15'}, {'Mag'}, {'n08'}, {}, {[15.5, 10.5]}, {1,1};...
    {'n16'}, {'Mag'}, {'n09'}, {'n20'}, {[15.5, 10.5]}, {1,1};...
    {'n17'}, {'Mag'}, {'n10'}, {'n21'}, {[15.5, 10.5]}, {1,1};...
    {'n18'}, {'Mag'}, {'n11'}, {'n22'}, {[15.5, 10.5]}, {1,1};...
    {'n19'}, {'Mag'}, {'n14'}, {'n23'}, {[15.5, 10.5]}, {1,1};...
    {'n20'}, {'Spt'}, {'n15'}, {}, {[25.5, 10.5]}, {1,1};...
    {'n21'}, {'Spt'}, {'n16'}, {'n09', 'n25'}, {[25.5, 10.5]}, {1,1};...
    {'n22'}, {'Spt'}, {'n17'}, {'n10', 'n26'}, {[25.5, 10.5]}, {1,1};...
    {'n23'}, {'Spt'}, {'n18'}, {'n11', 'n27'}, {[25.5, 10.5]}, {1,1};...
    {'n24'}, {'Spt'}, {'n19'}, {'n12', 'n28'}, {[25.5, 10.5]}, {1,1};...
    {'n25'}, {'Dsc'}, {'n20'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n26'}, {'Dsc'}, {'n21'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n27'}, {'Dsc'}, {'n22'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n28'}, {'Dsc'}, {'n23'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n29'}, {'Out'}, {'n24'}, {}, {[57.5, 15.5]}, {2,1};...
    {'n30'}, {'Dsc'}, {'n24'}, {}, {[2.5, 15.5]}, {1,1};...
    };
elseif (bioassayId==8)
    % NuIP With 8 RepEtiTions
    TB = {...
    {'n00'}, {'Dis'}, {}, {}, {[15.5, 2.5]}, {};...
    {'n01'}, {'Dis'}, {}, {}, {[45.5, 2.5]}, {1,1};...
    {'n02'}, {'Dis'}, {}, {}, {[45.5, 27.5]}, {1,1};...
    {'n03'}, {'Dis'}, {}, {'n13'}, {[45.5, 27.5]}, {1,1};...
    {'n04'}, {'Dis'}, {}, {'n14'}, {[45.5, 27.5]}, {1,1};...
    {'n05'}, {'Dis'}, {}, {'n15'}, {[45.5, 27.5]}, {1,1};...
    {'n06'}, {'Dis'}, {}, {'n16'}, {[45.5, 27.5]}, {1,1};...
    {'n07'}, {'Dis'}, {}, {'n17'}, {[45.5, 27.5]}, {1,1};...
    {'n08'}, {'Dis'}, {}, {'n18'}, {[45.5, 27.5]}, {1,1};...
    {'n09'}, {'Dis'}, {}, {'n19'}, {[45.5, 27.5]}, {1,1};...
    {'n10'}, {'Dis'}, {}, {}, {[15.5, 27.5]}, {1,1};...
    {'n11'}, {'Dis'}, {}, {'n20'}, {[45.5, 27.5]}, {1,1};...
    {'n12'}, {'Mix'}, {'n00', 'n01'}, {}, {[15.5, 20.5]}, {1,1};...
    {'n13'}, {'Mix'}, {'n32', 'n02'}, {}, {[45.5, 10.5]}, {1,1};...
    {'n14'}, {'Mix'}, {'n33', 'n03'}, {}, {[45.5, 20.5]}, {2,1};...
    {'n15'}, {'Mix'}, {'n34', 'n04'}, {'n23'}, {[15.5, 20.5]}, {2,1};...
    {'n16'}, {'Mix'}, {'n35', 'n05'}, {'n24'}, {[45.5, 10.5]}, {2,1};...
    {'n17'}, {'Mix'}, {'n36', 'n06'}, {'n25'}, {[45.5, 20.5]}, {2,1};...
    {'n18'}, {'Mix'}, {'n37', 'n07'}, {'n26'}, {[15.5, 20.5]}, {2,1};...
    {'n19'}, {'Mix'}, {'n38', 'n08'}, {'n27'}, {[45.5, 10.5]}, {2,1};...
    {'n20'}, {'Mix'}, {'n39', 'n09'}, {'n28'}, {[45.5, 20.5]}, {2,1};...
    {'n21'}, {'Mix'}, {'n20', 'n10'}, {'n29'}, {[15.5, 20.5]}, {1,1};...
    {'n22'}, {'Mix'}, {'n21', 'n11'}, {'n30'}, {[45.5, 10.5]}, {1,1};...
    {'n23'}, {'Mag'}, {'n12'}, {}, {[15.5, 10.5]}, {1,1};...
    {'n24'}, {'Mag'}, {'n13'}, {'n32'}, {[15.5, 10.5]}, {1,1};...
    {'n25'}, {'Mag'}, {'n14'}, {'n33'}, {[15.5, 10.5]}, {1,1};...
    {'n26'}, {'Mag'}, {'n15'}, {'n34'}, {[15.5, 10.5]}, {1,1};...
    {'n27'}, {'Mag'}, {'n16'}, {'n35'}, {[15.5, 10.5]}, {1,1};...
    {'n28'}, {'Mag'}, {'n17'}, {'n36'}, {[15.5, 10.5]}, {1,1};...
    {'n29'}, {'Mag'}, {'n18'}, {'n37'}, {[15.5, 10.5]}, {1,1};...
    {'n30'}, {'Mag'}, {'n19'}, {'n38'}, {[15.5, 10.5]}, {1,1};...
    {'n31'}, {'Mag'}, {'n22'}, {'n39'}, {[15.5, 10.5]}, {1,1};...
    {'n32'}, {'Spt'}, {'n23'}, {}, {[25.5, 10.5]}, {1,1};...
    {'n33'}, {'Spt'}, {'n24'}, {'n13', 'n41'}, {[25.5, 10.5]}, {1,1};...
    {'n34'}, {'Spt'}, {'n25'}, {'n14', 'n42'}, {[25.5, 10.5]}, {1,1};...
    {'n35'}, {'Spt'}, {'n26'}, {'n15', 'n43'}, {[25.5, 10.5]}, {1,1};...
    {'n36'}, {'Spt'}, {'n27'}, {'n16', 'n44'}, {[25.5, 10.5]}, {1,1};...
    {'n37'}, {'Spt'}, {'n28'}, {'n17', 'n45'}, {[25.5, 10.5]}, {1,1};...
    {'n38'}, {'Spt'}, {'n29'}, {'n18', 'n46'}, {[25.5, 10.5]}, {1,1};...
    {'n39'}, {'Spt'}, {'n30'}, {'n19', 'n47'}, {[25.5, 10.5]}, {1,1};...
    {'n40'}, {'Spt'}, {'n31'}, {'n20', 'n48'}, {[25.5, 10.5]}, {1,1};...
    {'n41'}, {'Dsc'}, {'n32'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n42'}, {'Dsc'}, {'n33'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n43'}, {'Dsc'}, {'n34'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n44'}, {'Dsc'}, {'n35'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n45'}, {'Dsc'}, {'n36'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n46'}, {'Dsc'}, {'n37'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n47'}, {'Dsc'}, {'n38'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n48'}, {'Dsc'}, {'n39'}, {}, {[2.5, 15.5]}, {1,1};...
    {'n49'}, {'Out'}, {'n40'}, {}, {[57.5, 15.5]}, {2,1};...
    {'n50'}, {'Dsc'}, {'n40'}, {}, {[2.5, 15.5]}, {1,1};...
    };
end

TB = cell2table(TB);
TB.Properties.VariableNames = {'vName','vType','vPre','vCond','vCp','vSptId'};
vCp = TB.vCp;




%%
%return

% Type
vSize = cell(size(TB,1),1);
vDr   = cell(size(TB,1),1);
vDroplets = cell(size(TB,1),1);
vLocations = cell(size(TB,1),1);

% Compute initial sizes
for r = 1:size(TB,1)
    if (strcmp(TB.vType{r},'Dis'))
        vSize{r} = 16;
    else
        vSize{r} = 0;
    end
end

%% Process Information
% vName
% vType
% vPre
% vDroplets
% vLocations

% Given: {'vName','vType','vPre','vCond','vCp'}



%% Compute sizes

bRepeat = true;
while (bRepeat)
    bRepeat = false;
    for r = 1:size(TB,1)
        if (vSize{r}==0)
            if (isempty(TB.vPre{r}))
                vSize{r} = fcnDrGetSize(vDr{r});
            else
                tmpIsReady = true;
                for i = 1:length(TB.vPre{r})
                    tmpIsReady = tmpIsReady && vSize{strcmp(TB.vName,TB.vPre{r}{i})};
                end
                if (tmpIsReady)
                    idx1 = strcmp(TB.vName,TB.vPre{r}{1});
                    if (length(TB.vPre{r})==2)
                        idx2 = strcmp(TB.vName,TB.vPre{r}{2});
                    else
                        idx2 = 0;
                    end
                    switch TB.vType{r}
                        case 'Mix'
                            vSize{r} = vSize{idx1}+vSize{idx2};
                        case 'Dlt'
                            vSize{r} = (vSize{idx1}+vSize{idx2})/2;
                        case 'Spt'
                            vSize{r} = vSize{idx1}/2;
                        case 'Mag'
                            vSize{r} = vSize{idx1};
                        case {'Out','Dsc'}
                            vSize{r} = vSize{idx1};
                        otherwise
                            fprintf('Error: Unknown type %s\n', TB.vType{r});
                            return
                    end
                else
                    bRepeat = true;
                end
            end
        end
    end
end

%% Compute Droplets
for r = 1:size(TB,1)
    vDr{r} = fcnDrGetDroplet(vCp{r},vSize{r});
end

%% Compute droplets and locations

for r = 1:size(TB,1)
    if (length(TB.vPre{r})==1)
        idx1 = strcmp(TB.vName,TB.vPre{r}{1});
        idx2 = 0;
    elseif (length(TB.vPre{r})==2)
        idx1 = strcmp(TB.vName,TB.vPre{r}{1});
        idx2 = strcmp(TB.vName,TB.vPre{r}{2});
    else
        idx1 = 0;
        idx2 = 0;
    end
    switch TB.vType{r}
        case 'Dis'
            vDroplets{r} = {fcnDrGetDisDroplet(vDr{r},60,30)};
            vLocations{r} = vDr(r);
        case 'Mix'
            vDroplets{r} = {...
                fcnDrGetDroplet(vCp{idx1},vSize{idx1}),...
                fcnDrGetDroplet(vCp{idx2},vSize{idx2})};
            vLocations{r} = {...
                fcnDrGetDroplet(vCp{r},vSize{idx1}),...
                fcnDrGetDroplet(vCp{r},vSize{idx2})};
        case 'Dlt'
            vDroplets{r} = {...
                fcnDrGetDroplet(vCp{idx1},vSize{idx1}),...
                fcnDrGetDroplet(vCp{idx2},vSize{idx2})};
            vLocations{r} = {...
                fcnDrGetDroplet(vCp{r},vSize{idx1}),...
                fcnDrGetDroplet(vCp{r},vSize{idx2})};
        case 'Spt'
            vDroplets{r} = {...
                fcnDrGetDroplet(vCp{idx1},vSize{idx1}/2),...
                fcnDrGetDroplet(vCp{idx1},vSize{idx1}/2)};
            vLocations{r} = {...
                fcnDrGetDroplet(vCp{r}-[4 0],vSize{idx1}/2),...
                fcnDrGetDroplet(vCp{r}+[4 0],vSize{idx1}/2)};
        case 'Mag'
            vDroplets{r} = {...
                fcnDrGetDroplet(vCp{idx1},vSize{idx1})};
            vLocations{r} = {...
                fcnDrGetDroplet(vCp{r},vSize{idx1})};
        case {'Out','Dsc'}
            vDroplets{r} = {...
                fcnDrGetDroplet(vCp{idx1},vSize{idx1})};
            vLocations{r} = {...
                fcnDrGetDroplet(vCp{r},vSize{idx1})};
            % Correct droplets
            W = ScObj.Width;
            H = ScObj.Height;
            dr = vLocations{r}{1};
            if (dr(1)<=1)
                tmpDelta = [(1-dr(1)),0,(1-dr(1)),0];
            elseif (dr(2)<=1)
                tmpDelta = [0,(1-dr(2)),0,(1-dr(2))];
            elseif (dr(3)>=W)
                tmpDelta = [-(W-dr(3)),0,-(W-dr(3)),0];
            elseif (dr(4)>=H)
                tmpDelta = [0,-(H-dr(4)),0,-(H-dr(4))];
            else
                fprintf('Error: %s cannot be dispensed!\n',mat2str(dr));
                tmpDelta = [0 0 0 0];
            end
            dr = dr + tmpDelta;
            vLocations{r}{1} = dr;
        otherwise
            fprintf('Error: Unknown type %s', vType{r});
            return
    end
end


%return

TB2 = [TB,...
    cell2table(vDroplets),...
    cell2table(vLocations),...
    cell2table(vSize),...
    cell2table(vDr)];

% Correct splits
%splitCount = zeros(size(TB2,1),1);
for r = 1:size(TB2,1)
    preIdx = {[],[]};
    for preLocIdx = 1:size(TB2.vPre{r})
        preIdx{preLocIdx} = strcmp(TB2.vName,TB2.vPre{r}{preLocIdx});
        if (strcmp(TB2.vType{preIdx{preLocIdx}},'Spt'))
            if (TB2.vSptId{r}{preLocIdx}==1)%(splitCount(preIdx{preLocIdx})==0)
                TB2.vDroplets{r}{preLocIdx} = TB2.vDroplets{r}{preLocIdx} - [4 0 4 0];
                %splitCount(preIdx{preLocIdx}) = splitCount(preIdx{preLocIdx}) + 1;
            else
                TB2.vDroplets{r}{preLocIdx} = TB2.vDroplets{r}{preLocIdx} + [4 0 4 0];
            end
        end
    end
end
    %if (strcmp(TB2.vType{r},'Spt')

for r = 1:size(TB2,1)
    %ScObj.mdAddMo('a5','Mix',{'a1','a2'},{a5j1s,a5j2s},{a5j1g,a5j2g});
    ScObj.mdAddMo(...
        TB2.vName{r},...
        TB2.vType{r},...
        TB2.vPre{r},...
        TB2.vDroplets{r},...
        TB2.vLocations{r},...
        TB2.vCond{r});
end

% Sanity checks:
for moId = 1:length(ScObj.MoList)
    for jobId = 1:length(ScObj.MoList(moId).jobList)
        % Check if start and end sizes are the same
        if ( (fcnDrGetSize(ScObj.MoList(moId).jobList(jobId).droplet))~=...
                (fcnDrGetSize(ScObj.MoList(moId).jobList(jobId).goal)) )
            fprintf('Error: %02d.%02d size mismatch!\n',moId,jobId);
            pause;
        end
        % Check if droplets are out of bounds
        if ( (~strcmp(ScObj.MoList(moId).type,'Dis')) && ...
                ( (fcnDrIsOutOfBounds(ScObj.MoList(moId).jobList(jobId).droplet)) || ...
                  (fcnDrIsOutOfBounds(ScObj.MoList(moId).jobList(jobId).goal)) ) )
            fprintf('Error: %02d.%02d out of bounds!\n',moId,jobId);
            pause;
        end
    end
end



end